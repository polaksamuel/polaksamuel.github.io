<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üß© Guess Who?</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b0e1a; --ink:#e9ecff; --card:#131735; --rim:#2b3170; --brand:#38d3ff; --good:#25d366; --bad:#ff5a66; }
  *{box-sizing:border-box}
  body{font-family:Poppins,system-ui,sans-serif;background:var(--bg);color:var(--ink);display:flex;justify-content:center;padding:28px}
  .wrap{max-width:980px;width:100%}
  h1{margin:0 0 18px;text-align:center}
  .card{background:var(--card);border:1px solid var(--rim);border-radius:18px;padding:20px;box-shadow:0 18px 42px rgba(0,0,0,.28)}
  .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0f1430;border:1px solid var(--rim);border-radius:999px;padding:4px 10px;font-size:.85rem}
  .stage{background:#0c0f22;border-radius:14px;padding:14px}
  canvas{width:100%;max-width:920px;height:auto;border-radius:12px;background:#0a0d20}
  input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #293166;background:#0b1130;color:var(--ink);outline:none}
  button{padding:10px 14px;border-radius:12px;border:1px solid #1a8bb0;background:var(--brand);color:#001022;font-weight:700;cursor:pointer}
  button.secondary{background:#111a3a;border-color:#2b3170;color:#cfe6ff}
  button.small{padding:6px 10px;border-radius:9px;font-size:.85rem}
  .muted{opacity:.85}
  .section{margin-top:16px}
  .list{font-size:.95rem}
  .good{color:var(--good)} .bad{color:var(--bad)}

  /* DEV */
  #devBox{display:none;margin-top:18px;background:#0b0f29;border:1px dashed #3a4aa0;padding:14px;border-radius:14px}
  #devBox h3{margin:0 0 8px}
  #devBox .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  #devBox label{font-size:.9rem;opacity:.9}
  #devBox input[type="range"]{width:100%}
  #jsonOut{background:#0a0f24;border:1px solid #2b3170;color:#c9f0ff;padding:10px;border-radius:8px;overflow:auto;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  #dbg{position:fixed;left:10px;bottom:10px;background:#0a0f24;border:1px solid #335;padding:8px 10px;border-radius:10px;max-width:70vw;font:12px/1.35 monospace;color:#9fe;opacity:.92;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>üß© Guess Who?</h1>
  <div class="card">

    <div class="toprow">
      <div class="pill"><strong id="qText">Name that Hall 2007 Grad</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="pill">round: <span id="roundId">‚Äî</span></span>
        <span class="pill">‚è± <span id="count">‚Äî</span>s</span>
        <button id="revealBtn" class="small secondary" title="Force reveal (admin/dev only)" style="display:none">reveal</button>
      </div>
    </div>

    <div class="stage">
      <canvas id="canvas" width="920" height="560"></canvas>
    </div>

    <div class="section" style="display:flex;gap:8px;align-items:center">
      <input id="guess" type="text" placeholder="Type your guess here"/>
      <button id="submitBtn">Submit</button>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px">üßæ All Answers</h3>
      <div id="answers" class="list muted">Hidden until reveal‚Ä¶</div>
    </div>

    <div class="section">
      <h3 style="margin:0 0 6px">üèÜ Leaderboard</h3>
      <div id="board" class="list muted">No scores yet.</div>
    </div>

    <!-- DEV PANEL -->
    <div id="devBox">
      <h3>üîß Dev tools</h3>
      <div class="grid">
        <div>
          <label>Preview page image (URL or filename like <code>page02.png</code>)</label>
          <input id="devPageUrl" type="text" placeholder="https://weha07boyoz.com/page02.png or page02.png" list="pageList"/>
          <datalist id="pageList"></datalist>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="devLoad" class="small secondary">Load for preview</button>
            <button id="devClear" class="small secondary">Use round‚Äôs image</button>
          </div>
          <div class="muted" style="margin-top:6px">Preview does not affect the live round until you save.</div>
        </div>
        <div>
          <label>New round ‚Äúanswer‚Äù (what players must type)</label>
          <input id="devAnswer" type="text" placeholder="e.g., Rosaline Abraham"/>
          <label style="margin-top:8px">pageImage URL to save with the round</label>
          <input id="devSaveUrl" type="text" placeholder="https://weha07boyoz.com/page02.png"/>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>xPct</label><input id="xPct" type="range" min="0" max="1" step="0.01" value="0">
          <label>yPct</label><input id="yPct" type="range" min="0" max="1" step="0.01" value="0">
        </div>
        <div>
          <label>wPct</label><input id="wPct" type="range" min="0.05" max="1" step="0.01" value="1">
          <label>hPct</label><input id="hPct" type="range" min="0.05" max="1" step="0.01" value="1">
        </div>
      </div>

      <div style="margin-top:10px">Copy crop JSON:</div>
      <pre id="jsonOut">{ "xPct": 0, "yPct": 0, "wPct": 1, "hPct": 1 }</pre>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="saveRoundBtn">üíæ Save round</button>
        <button id="nextRandomBtn" class="secondary">Next (Random)</button>
      </div>
      <div class="muted" style="margin-top:6px">Saving auto-picks new <code>r00x</code> and switches the room to it.</div>
    </div>

  </div>
</div>

<div id="dbg"></div>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, doc, onSnapshot, getDoc, setDoc, updateDoc, collection,
  getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_YzaooeCA-VpI3gZgpQ7F3QoJzmlbe0s",
  authDomain: "weha07boyoz-game.firebaseapp.com",
  projectId: "weha07boyoz-game",
  storageBucket: "weha07boyoz-game.firebasestorage.app",
  messagingSenderId: "300785635491",
  appId: "1:300785635491:web:d3ef9caa6156a18788ef16"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* =============== Elements & flags =============== */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const qText = document.getElementById('qText');
const roundIdEl = document.getElementById('roundId');
const countEl = document.getElementById('count');
const revealBtn = document.getElementById('revealBtn');
const guessInput = document.getElementById('guess');
const submitBtn = document.getElementById('submitBtn');
const answersEl = document.getElementById('answers');
const boardEl = document.getElementById('board');
const dbg = document.getElementById('dbg');

const params = new URLSearchParams(location.search);
const isDev = params.has('dev');
const isAdmin = params.has('admin');
if (isDev) dbg.style.display = 'block';
if (isDev) document.getElementById('devBox').style.display = 'block';
if (isDev || isAdmin) revealBtn.style.display = 'inline-block';
function log(...a){ if(!isDev) return; dbg.textContent = a.map(x => typeof x==='object'?JSON.stringify(x):String(x)).join(' '); console.log(...a); }

const ROOM_ID = 'game1';
const roomRef = doc(db, 'rooms', ROOM_ID);

/* identity */
let playerId = localStorage.getItem('playerId');
if (!playerId) { playerId = crypto.randomUUID(); localStorage.setItem('playerId', playerId); }
let playerName = localStorage.getItem('playerName');
if (!playerName) { playerName = prompt("Enter your name:") || "Player"; localStorage.setItem('playerName', playerName); }

/* =============== Image helpers =============== */
let roundState = { id:null, answer:"", crop:null, pageImage:"", revealAt:0 };
let roundImg = null;
let devOverrideImg = null;
let devOverrideUrl = "";
let ticker = null;

function resolveUrl(s){
  if (!s) return "";
  if (/^https?:\/\//i.test(s)) return s;
  return `https://weha07boyoz.com/${s.replace(/^\/+/,'')}`;
}
function loadImage(url){
  return new Promise((res,rej)=>{
    const img = new Image();
    img.onload=()=>res(img); img.onerror=()=>rej(new Error('image fail '+url)); img.src=url;
  });
}
function normalizeCrop(c){
  const x=+c?.xPct, y=+c?.yPct, w=+c?.wPct, h=+c?.hPct;
  return {
    xPct: Number.isFinite(x)?x:0,
    yPct: Number.isFinite(y)?y:0,
    wPct: Number.isFinite(w)&&w>0?w:1,
    hPct: Number.isFinite(h)&&h>0?h:1
  };
}
function draw(){
  const img = devOverrideImg || roundImg;
  if (!img) return;
  const c = normalizeCrop(roundState.crop||{});
  let {xPct,yPct,wPct,hPct} = c;
  wPct = Math.min(wPct, 1-xPct);
  hPct = Math.min(hPct, 1-yPct);
  const W = img.naturalWidth, H = img.naturalHeight;
  const sx = Math.round(xPct*W), sy = Math.round(yPct*H);
  const sw = Math.max(1, Math.round(wPct*W)), sh = Math.max(1, Math.round(hPct*H));
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.imageSmoothingQuality='high';
  ctx.drawImage(img, sx,sy,sw,sh, 0,0, canvas.width,canvas.height);
}

/* =============== Fuzzy scoring =============== */
function _norm(s){ return (s||"").toLowerCase().trim().replace(/\s+/g," "); }
function levenshtein(a,b){
  const m=[]; for(let i=0;i<=b.length;i++) m[i]=[i]; for(let j=0;j<=a.length;j++) m[0][j]=j;
  for(let i=1;i<=b.length;i++){ for(let j=1;j<=a.length;j++){
    m[i][j]= b[i-1]===a[j-1] ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
  }} return m[b.length][a.length];
}
function scoreGuess(target, guess){
  const t=_norm(target), g=_norm(guess);
  if(!t||!g) return {correct:false, pts:0};
  if (t===g) return {correct:true, pts:3};          // exact
  if (levenshtein(t,g)<=2) return {correct:true, pts:1.5}; // fuzzy
  return {correct:false, pts:0};
}

/* =============== Room & round subscriptions =============== */
let unsubRound = null;
onSnapshot(roomRef, async (snap)=>{
  if(!snap.exists()) return;
  const r = snap.data()||{};
  qText.textContent = r.question || 'Who is this?';
  const rid = r.currentRoundId;
  roundIdEl.textContent = rid || '‚Äî';

  revealBtn.onclick = async ()=>{
    if (!rid) return;
    await updateDoc(roomRef, { revealAt: Date.now() });
  };

  // Timer display
  if (ticker) clearInterval(ticker);
  ticker = setInterval(()=>{
    const left = Math.max(0, Math.ceil(((r.revealAt||0)-Date.now())/1000));
    countEl.textContent = left;
  }, 200);

  if (!rid) return;

  // Switch round subscription
  if (unsubRound) unsubRound();
  const rRef = doc(db, 'rooms', ROOM_ID, 'rounds', rid);
  unsubRound = onSnapshot(rRef, async(s2)=>{
    if(!s2.exists()) return;
    const d = s2.data()||{};
    roundState = {
      id: rid,
      answer: d.answer || "",
      crop: d.crop || {xPct:0,yPct:0,wPct:1,hPct:1},
      pageImage: resolveUrl(d.pageImage||"")
    };
    try{
      roundImg = await loadImage(roundState.pageImage);
      if (!devOverrideImg) draw(); // if previewing, don't overwrite
    }catch(e){ log('IMG FAIL', e.message); }
  });

  // Answers list (masked until reveal)
  const ansCol = collection(db, 'rooms', ROOM_ID, 'rounds', rid, 'answers');
  onSnapshot(ansCol, (qs)=>{
    const all = [];
    qs.forEach(d=> all.push({id:d.id, ...d.data()}));
    const revealed = (r.revealAt||0) <= Date.now();
    if (!revealed){
      answersEl.innerHTML = 'Hidden until reveal‚Ä¶';
    }else{
      if(!all.length){ answersEl.textContent='(no guesses)'; return; }
      answersEl.innerHTML = all.map(g=>{
        const sc = scoreGuess(roundState.answer, g.guess||"");
        return `<div>‚Ä¢ <strong>${escapeHtml(g.name||'Player')}</strong>: ‚Äú${escapeHtml(g.guess||'') }‚Äù ${sc.correct?'<span class="good">‚úî</span>':'<span class="bad">‚úñ</span>'} <span class="muted">(${sc.pts} pts)</span></div>`;
      }).join('');
    }
  });
});

/* Leaderboard */
onSnapshot(collection(db, 'rooms', ROOM_ID, 'Players'), (qs)=>{
  const list=[]; qs.forEach(d=> list.push(d.data())); 
  list.sort((a,b)=> (b.score||0)-(a.score||0));
  boardEl.innerHTML = list.length ? list.map(p=>`<div>${escapeHtml(p.name||'Player')}: <strong>${(p.score||0).toFixed(1)}</strong> pts</div>`).join('') : 'No scores yet.';
});

/* =============== Submit guess (1 per round) =============== */
submitBtn.addEventListener('click', async ()=>{
  if (!roundState.id) return;
  const guess = (guessInput.value||"").trim();
  if (!guess) return;

  const r = await getDoc(roomRef);
  const room = r.data()||{};
  const revealed = (room.revealAt||0) <= Date.now();
  if (revealed){
    alert("Time's up ‚Äî wait for the next round!");
    return;
  }

  // only one per round
  const ansRef = doc(db, 'rooms', ROOM_ID, 'rounds', roundState.id, 'answers', playerId);
  const aSnap = await getDoc(ansRef);
  if (aSnap.exists()){
    alert("You already guessed this round.");
    return;
  }

  await setDoc(ansRef, {
    name: playerName,
    guess,
    ts: Date.now()
  }, { merge:true });

  guessInput.value = "";
});

/* When reveal happens, award points */
onSnapshot(roomRef, async (snap)=>{
  if(!snap.exists()) return;
  const r = snap.data()||{};
  if (!roundState.id) return;

  if ((r.revealAt||0) > 0 && (r.revealAt||0) <= Date.now()){
    const qs = await getDocs(collection(db, 'rooms', ROOM_ID, 'rounds', roundState.id, 'answers'));
    const updates = [];
    for (const docSnap of qs.docs){
      const g = docSnap.data()||{};
      const sc = scoreGuess(roundState.answer, g.guess||"");
      if (!sc.pts) continue;
      const playerRef = doc(db, 'rooms', ROOM_ID, 'Players', docSnap.id);
      const pSnap = await getDoc(playerRef);
      const prev = (pSnap.exists() && typeof pSnap.data().score==='number') ? pSnap.data().score : 0;
      updates.push(setDoc(playerRef, { name: g.name||'Player', score: +(prev + sc.pts) }, { merge:true }));
    }
    if (updates.length) await Promise.all(updates);
  }
});

/* =============== DEV: page picker + save round =============== */
const devBox = document.getElementById('devBox');
const devPageUrl = document.getElementById('devPageUrl');
const devSaveUrl = document.getElementById('devSaveUrl');
const devAnswer = document.getElementById('devAnswer');
const devLoadBtn = document.getElementById('devLoad');
const devClearBtn = document.getElementById('devClear');
const saveRoundBtn = document.getElementById('saveRoundBtn');
const nextRandomBtn = document.getElementById('nextRandomBtn');
const xSl=document.getElementById('xPct'), ySl=document.getElementById('yPct'), wSl=document.getElementById('wPct'), hSl=document.getElementById('hPct');
const jsonOut=document.getElementById('jsonOut');
const pageList = document.getElementById('pageList');

if (isDev){
  // datalist page01..page60
  const opts = Array.from({length:60},(_,i)=>`page${String(i+1).padStart(2,'0')}.png`);
  pageList.innerHTML = opts.map(p=>`<option value="${p}">`).join('');
  devPageUrl.setAttribute('list','pageList');

  const hydrateSliders = ()=>{
    const c = normalizeCrop(roundState.crop||{});
    xSl.value=c.xPct; ySl.value=c.yPct; wSl.value=c.wPct; hSl.value=c.hPct;
    jsonOut.textContent = JSON.stringify({
      xPct:+xSl.value, yPct:+ySl.value, wPct:+wSl.value, hPct:+hSl.value
    }, null, 2);
  };
  hydrateSliders();

  [xSl,ySl,wSl,hSl].forEach(sl=> sl.addEventListener('input', ()=>{
    jsonOut.textContent = JSON.stringify({
      xPct:+xSl.value, yPct:+ySl.value, wPct:+wSl.value, hPct:+hSl.value
    }, null, 2);
    draw();
  }));

  devLoadBtn.addEventListener('click', async ()=>{
    const raw = (devPageUrl.value||"").trim();
    if (!raw) return;
    const url = resolveUrl(raw);
    try{
      devOverrideImg = await loadImage(url);
      devOverrideUrl = url;
      devSaveUrl.value = url;
      draw();
    }catch(e){ alert("Couldn‚Äôt load image. Check the URL/filename."); }
  });
  devClearBtn.addEventListener('click', ()=>{
    devOverrideImg = null; devOverrideUrl=""; draw();
  });

  async function nextRoundId(){
    const qs = await getDocs(collection(db, 'rooms', ROOM_ID, 'rounds'));
    let max = 0;
    qs.forEach(d=>{
      const m = /^r(\d+)$/.exec(d.id);
      if (m) max = Math.max(max, +m[1]);
    });
    return 'r'+String(max+1).padStart(3,'0');
  }

  saveRoundBtn.addEventListener('click', async ()=>{
    const answer = (devAnswer.value||"").trim();
    const pageU = (devSaveUrl.value||"").trim() || devOverrideUrl || roundState.pageImage;
    if (!answer || !pageU){ alert("Provide an answer and a page image URL/filename."); return; }
    const crop = { xPct:+xSl.value, yPct:+ySl.value, wPct:+wSl.value, hPct:+hSl.value };
    try{
      const id = await nextRoundId();
      await setDoc(doc(db, 'rooms', ROOM_ID, 'rounds', id), {
        answer, pageImage: pageU, crop, createdAt: serverTimestamp()
      }, { merge:true });
      await updateDoc(roomRef, { currentRoundId: id, revealAt: Date.now()+15000 });
      alert(`Saved ${id} and switched the room.`);
      devOverrideImg = null; devOverrideUrl=""; // go back to round image
    }catch(e){ console.error(e); alert("Save failed (rules?). Open console."); }
  });

  nextRandomBtn.addEventListener('click', async ()=>{
    const qs = await getDocs(collection(db, 'rooms', ROOM_ID, 'rounds'));
    const ids = qs.docs.map(d=>d.id);
    if (!ids.length) return alert("No rounds found.");
    const cur = (await getDoc(roomRef)).data()?.currentRoundId;
    let pick = ids[Math.floor(Math.random()*ids.length)];
    if (ids.length>1){ while(pick===cur) pick = ids[Math.floor(Math.random()*ids.length)]; }
    await updateDoc(roomRef, { currentRoundId: pick, revealAt: Date.now()+15000 });
  });

  onSnapshot(roomRef, ()=> setTimeout(()=>hydrateSliders(), 50));
}

/* =============== Utils =============== */
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
window.addEventListener('resize', draw);
</script>
</body>
</html>
